<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>A 2D transform fault overlaying a 3D mantle ¬∑ Oetqf</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Oetqf</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>A 2D transform fault overlaying a 3D mantle</a></li></ul></li><li><a class="tocitem" href="../../APIs/">APIs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>A 2D transform fault overlaying a 3D mantle</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>A 2D transform fault overlaying a 3D mantle</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/shipengcheng1230/Oetqf.jl/blob/master/examples/otf-with-mantle.jl" title="Edit on GitHub"><span class="docs-icon fab">ÔÇõ</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This example corresponds to the simulations in Shi, P., Wei, M., &amp; Barbot, S., (2022), submitted to JGR - Solid Earth. The mesh size is downgraded for speed of the document building</p></div></div><pre><code class="language-julia hljs">using Oetqf, SpecialFunctions, Optim</code></pre><p>Generate the mesh for the transform fault, which is suited for using Okaka, (1992) equation:</p><pre><code class="language-julia hljs">mf = gen_mesh(Val(:RectOkada), 80e3, 8e3, 10e3, 2e3, 90.0);</code></pre><p>Use Gmsh to generate the mantle mesh, which is suited for using Barbot et al., (2017) equation, with no refinement in <strong>x</strong> or <strong>y</strong> direction while cell sizes are 1.5 times progressively larger along <strong>z</strong> axes:</p><pre><code class="language-julia hljs">gen_gmsh_mesh(Val(:BEMHex8Mesh), -40e3, -2.5e3, -8e3, 80e3, 5e3, -22e3, 4, 3, 3;
    output = joinpath(@__DIR__, &quot;mantle.vtk&quot;),
    rfzh = cumprod(ones(3) * 1.5), rfy = 1.0, rfyType = &quot;Bump&quot;
)
ma = gen_mesh(Val(:BEMHex8Mesh), joinpath(@__DIR__, &quot;mantle.vtk&quot;));</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 20%] Meshing curve 3 (Line)
Info    : [ 30%] Meshing curve 4 (Line)
Info    : [ 40%] Meshing curve 6 (Extruded)
Info    : [ 50%] Meshing curve 7 (Extruded)
Info    : [ 50%] Meshing curve 8 (Extruded)
Info    : [ 60%] Meshing curve 9 (Extruded)
Info    : [ 70%] Meshing curve 11 (Extruded)
Info    : [ 80%] Meshing curve 12 (Extruded)
Info    : [ 90%] Meshing curve 16 (Extruded)
Info    : [100%] Meshing curve 20 (Extruded)
Info    : Done meshing 1D (Wall 0.000261217s, CPU 0.000264s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Transfinite)
Info    : [ 20%] Meshing surface 13 (Extruded)
Info    : [ 40%] Meshing surface 17 (Extruded)
Info    : [ 50%] Meshing surface 21 (Extruded)
Info    : [ 70%] Meshing surface 25 (Extruded)
Info    : [ 90%] Meshing surface 26 (Extruded)
Info    : Done meshing 2D (Wall 0.000355723s, CPU 0.000347s)
Info    : Meshing 3D...
Info    : Meshing volume 1 (Extruded)
Info    : Done meshing 3D (Wall 0.00015881s, CPU 0.000155s)
Info    : Optimizing mesh...
Info    : Done optimizing mesh (Wall 4e-06s, CPU 4e-06s)
Info    : 80 nodes 150 elements
Info    : Writing &#39;/home/runner/work/Oetqf.jl/Oetqf.jl/docs/build/generated/mantle.vtk&#39;...
Info    : Done writing &#39;/home/runner/work/Oetqf.jl/Oetqf.jl/docs/build/generated/mantle.vtk&#39;
Info    : Reading &#39;/home/runner/work/Oetqf.jl/Oetqf.jl/docs/build/generated/mantle.vtk&#39;...
Info    : Reading 80 points
Info    : Reading 150 cells
Info    : Done reading &#39;/home/runner/work/Oetqf.jl/Oetqf.jl/docs/build/generated/mantle.vtk&#39;</code></pre><p>Compute the stress Green&#39;s function between the two meshes:</p><pre><code class="language-julia hljs">Œª = Œº = 3e10
gffile = joinpath(@__DIR__, &quot;gf.h5&quot;)
isfile(gffile) &amp;&amp; rm(gffile)
@time gf‚ÇÅ‚ÇÅ = stress_greens_function(mf, Œª, Œº; buffer_ratio = 1)
h5write(gffile, &quot;gf‚ÇÅ‚ÇÅ&quot;, gf‚ÇÅ‚ÇÅ) # fault -&gt; fault
@time gf‚ÇÅ‚ÇÇ = stress_greens_function(mf, ma, Œª, Œº; buffer_ratio = 1, qtype = &quot;Gauss1&quot;)
h5write(gffile, &quot;gf‚ÇÅ‚ÇÇ&quot;, gf‚ÇÅ‚ÇÇ) # fault -&gt; mantle
@time gf‚ÇÇ‚ÇÅ = stress_greens_function(ma, mf, Œª, Œº)
h5write(gffile, &quot;gf‚ÇÇ‚ÇÅ&quot;, gf‚ÇÇ‚ÇÅ) # mantle -&gt; fault
@time gf‚ÇÇ‚ÇÇ = stress_greens_function(ma, Œª, Œº; qtype = &quot;Gauss1&quot;)
h5write(gffile, &quot;gf‚ÇÇ‚ÇÇ&quot;, gf‚ÇÇ‚ÇÇ) # mantle -&gt; mantle</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">  2.399431 seconds (4.32 M allocations: 229.974 MiB, 3.88% gc time, 99.92% compilation time)
  0.434018 seconds (507.98 k allocations: 26.951 MiB, 81.36% compilation time)
  5.402048 seconds (9.60 M allocations: 416.898 MiB, 3.21% gc time, 67.24% compilation time)
Maximum real part of eigval is: 1111120100.9503
 12.904420 seconds (1.34 M allocations: 71.851 MiB, 0.38% gc time, 7.52% compilation time)</code></pre><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>The <code>buffer_ratio</code> denotes the fraction to the original fault length on the two sides of the fault in which no dislocation occurs. It serves as a buffer zone to immitate the ridge section on the edges of an oceanic transform fault (personal communication with Yajing Liu). Basically, it affects how the stiffness tensor are periodically summed.</p></div></div><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>Notice that, in Gmsh before v4.9, the quadrature type &quot;Gauss2&quot; does not stand for the product rule, instead it is an optimized cubature rule (see <a href="https://gitlab.onelab.info/gmsh/gmsh/-/issues/1351">this issue</a>). For more cubature rules, see <a href="https://github.com/nschloe/quadpy">quadpy</a>.</p></div></div><p>Set up the rate-and-state friction parameters in the fault:</p><pre><code class="language-julia hljs">cs = 3044.14 # m/s
vpl = 140e-3 / 365 / 86400 # 140 mm/yr
v0 = 1e-6
f0 = 0.6
Œº = 3e10
Œ∑ = Œº / 2cs # radiation damping
ŒΩ = Œª / 2(Œª + Œº)
avw = 0.015
abvw = 0.0047
Dc = 8e-3
œÉmax = 5e7
a = ones(mf.nx, mf.nŒæ) .* avw
b = ones(mf.nx, mf.nŒæ) .* (avw - abvw)
L = ones(mf.nx, mf.nŒæ) .* Dc
œÉ = [min(œÉmax, 1.5e6 + 18.0e3 * z) for z in -mf.z] # Pa
œÉ = repeat(œÉ, 1, mf.nx)&#39; |&gt; Matrix # Pa
left_patch = @. -25.e3 ‚â§ mf.x ‚â§ -5.e3
right_patch = @. 5.e3 ‚â§ mf.x ‚â§ 25.e3
vert_patch = @. -6.e3 ‚â§ mf.z ‚â§ -1e3
b[xor.(left_patch, right_patch), vert_patch] .= avw + abvw # assign velocity weakening
pf = RateStateQuasiDynamicProperty(a, b, L, œÉ, Œ∑, vpl, f0, v0)
save_property(joinpath(@__DIR__, &quot;para-fault.bson&quot;), pf);</code></pre><p>Set up rheology parameters in the mantle assuming power-law viscosity with lab-derived results:</p><pre><code class="language-julia hljs">A_wet_dis = 3e1
Q_wet_dis = 480e3
V_wet_dis = 11e-6
m_wet_dis = 0
r_wet_dis = 1.2
n_wet_dis = 3.5
grain_size = 10000.0 # Œºm
COH = 1000 # ppm / HSi
ùôç = 8.314 # gas contant
crust_depth = 7e3
Œ∫ = 8e-7
ùöÉ(z) = 1673 * erf(z / sqrt(4Œ∫ * 1e6 * 365 * 86400)) # 1 Myr OTF
ùôø(z) = 2800 * 9.8 * crust_depth + 3300 * 9.8 * (z - crust_depth)
prefactor_dis(z) = A_wet_dis / (1e6)^n_wet_dis * COH^r_wet_dis * grain_size^m_wet_dis * exp(-(Q_wet_dis + ùôø(z) * V_wet_dis) / ùôç / ùöÉ(z))
rel_dœµ = [0.0, -1e-12, 0.0, 0.0, 0.0, 0.0]
amplifier = 1e0
Œ≥_dis = prefactor_dis.(-ma.cz) .* amplifier
pa = PowerLawViscosityProperty(Œ≥_dis, ones(length(ma.cz)) * (n_wet_dis - 1), rel_dœµ) # notice to save `n-1` instead of `n` where `n` refers the stress power
save_property(joinpath(@__DIR__, &quot;para-mantle&quot; * &quot;.bson&quot;), pa);</code></pre><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Make sure your units are consistent across the whole variable space. Also, notice that we save <code>n-1</code> instead of <code>n</code> where <code>n</code> refers the stress power.</p></div></div><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>To load existing properties, use <code>load_property(YOUR_FILE, :RateStateQuasiDynamicProperty)</code> or <code>load_property(YOUR_FILE, :PowerLawViscosityProperty)</code> accordingly.</p></div></div><p>Set up initial conditions on the fault with an offset between left and right half fault:</p><pre><code class="language-julia hljs">vinit = pf.vpl .* ones(size(pf.a))
Œ∏init = pf.L ./ vinit
Œ∏init[1: size(Œ∏init, 1) &gt;&gt; 1, :] ./= 1.1
Œ∏init[size(Œ∏init, 1) &gt;&gt; 1 + 1: end, :] ./= 2.5
Œ¥init = zeros(size(pf.a));</code></pre><p>Set up initial conditions in the mantle</p><pre><code class="language-julia hljs">œµinit = zeros(length(pa.Œ≥), 6)
P = map(z -&gt; 2800 * 9.8 * crust_depth + 3300 * 9.8 * (z - crust_depth), -ma.cz) # change the depth of crust
œÉinit = repeat(P, 1, 6)
œÉinit[:,3] .= 0.0 # xz
œÉinit[:,5] .= 0.0 # yz
target(i) = x -&gt; (pa.Œ≥[i] * (sqrt(2) * x) ^ (pa.n[i]) * x - abs(pa.dœµ‚ÇÄ[2])) ^ 2
œÉxyinit = -map(i -&gt; Optim.minimizer(optimize(target(i), 1e1, 1e14)), 1: length(pa.Œ≥))
reldœµ = map(i -&gt; pa.Œ≥[i] * (sqrt(2) * abs(œÉxyinit[i])) ^ (pa.n[i]) * œÉxyinit[i], 1: length(pa.Œ≥))
@assert all(isapprox.(reldœµ, pa.dœµ‚ÇÄ[2]; rtol=1e-3))
œÉinit[:,2] .= œÉxyinit;</code></pre><p>Assemble the problem:</p><pre><code class="language-julia hljs">uinit = ArrayPartition(vinit, Œ∏init, œµinit, œÉinit, Œ¥init)
prob = assemble(gf‚ÇÅ‚ÇÅ, gf‚ÇÅ‚ÇÇ, gf‚ÇÇ‚ÇÅ, gf‚ÇÇ‚ÇÇ, pf, pa, uinit, (0.0, 0.1 * 365 * 86400));</code></pre><p>Set up the saving scheme and solve the equation:</p><pre><code class="language-julia hljs">handler(u::ArrayPartition, t, integrator) = (u.x[1], u.x[2], integrator(integrator.t, Val{1}).x[3], u.x[3], u.x[4], u.x[5])
output = joinpath(@__DIR__, &quot;output.h5&quot;)
@time sol = wsolve(prob, VCABM5(), output, 100, handler, [&quot;v&quot;, &quot;Œ∏&quot;, &quot;dœµ&quot;, &quot;œµ&quot;, &quot;œÉ&quot;, &quot;Œ¥&quot;], &quot;t&quot;;
    reltol=1e-6, abstol=1e-8, dtmax=0.2*365*86400, dt=1e-8, maxiters=1e9, stride=100, force=true
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
Interpolation: 1st order linear
t: 2-element Vector{Float64}:
 0.0
 3.1536e6
u: 2-element Vector{ArrayPartition{Float64, NTuple{5, Matrix{Float64}}}}:
 ([4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9; 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9; ‚Ä¶ ; 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9; 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9 4.439370877727043e-9], [1.6382337662337658e6 1.6382337662337658e6 1.6382337662337658e6 1.6382337662337658e6; 1.6382337662337658e6 1.6382337662337658e6 1.6382337662337658e6 1.6382337662337658e6; ‚Ä¶ ; 720822.857142857 720822.857142857 720822.857142857 720822.857142857; 720822.857142857 720822.857142857 720822.857142857 720822.857142857], [0.0 0.0 ‚Ä¶ 0.0 0.0; 0.0 0.0 ‚Ä¶ 0.0 0.0; ‚Ä¶ ; 0.0 0.0 ‚Ä¶ 0.0 0.0; 0.0 0.0 ‚Ä¶ 0.0 0.0], [2.993126315789474e8 -1.159793132258934e6 ‚Ä¶ 0.0 2.993126315789474e8; 4.865442105263158e8 -279723.0841659712 ‚Ä¶ 0.0 4.865442105263158e8; ‚Ä¶ ; 4.865442105263158e8 -279723.0841659712 ‚Ä¶ 0.0 4.865442105263158e8; 7.673915789473685e8 -235923.5595516861 ‚Ä¶ 0.0 7.673915789473685e8], [0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0; ‚Ä¶ ; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0])
 ([4.0767159594235405e-9 4.0726161646218115e-9 4.075442712505631e-9 4.088964986854444e-9; 3.4430994936084665e-9 3.417383507316748e-9 3.4394142405451146e-9 4.062644180138336e-9; ‚Ä¶ ; 7.586803545971388e-10 7.350000917671253e-10 7.495634426596897e-10 2.050210814376089e-9; 2.0738117751487143e-9 2.038088908694873e-9 2.04703978043994e-9 2.0960945203688157e-9], [1.859041830005468e6 1.8598256458685251e6 1.8593496130393536e6 1.857018956937463e6; 2.0017790267709633e6 2.0064139281263128e6 2.002447943695447e6 1.861281287169844e6; ‚Ä¶ ; 2.87470435919983e6 2.885326685849754e6 2.878660033158451e6 2.27726833669272e6; 2.270762721125289e6 2.279965835489089e6 2.2775965956855654e6 2.264780686989732e6], [-1.9490353620031998e-10 -3.1502254797285903e-6 ‚Ä¶ 1.1170093924188178e-10 -5.760585512089933e-12; -3.143400768082191e-10 -3.147648023537708e-6 ‚Ä¶ 4.658202394508259e-10 -4.579661829808136e-11; ‚Ä¶ ; -5.615414365772426e-10 -3.130506294386605e-6 ‚Ä¶ -9.98693010954035e-10 -6.37906389157408e-10; -1.2895019450552975e-10 -3.144725879035746e-6 ‚Ä¶ -6.507466234411018e-10 -2.713827658666108e-10], [2.993123106670303e8 -1.1588113187960377e6 ‚Ä¶ 109.26822528313409 2.993125101945185e8; 4.865440819229595e8 -279332.7091137653 ‚Ä¶ 107.1541536277877 4.865441499927153e8; ‚Ä¶ ; 4.865439287083998e8 -278353.0326551578 ‚Ä¶ -211.77387653432865 4.865439457601052e8; 7.673915013824514e8 -235463.2839044049 ‚Ä¶ -117.5952536778349 7.673914887318368e8], [0.0133529772462193 0.013347861796139792 0.01335086397318031 0.01336568039662874; 0.012402031284312586 0.01237569089985771 0.01239823817095998 0.013339120424513825; ‚Ä¶ ; 0.005481590408943952 0.005435821491326209 0.005464692151618529 0.008821136598718868; 0.008856835911829546 0.008807659334967277 0.008820414519594021 0.0088895007217099])</code></pre><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>See <a href="https://github.com/SciML/OrdinaryDiffEq.jl/issues/785">this issue</a> to know more about retrieving derivatives in the solution.</p></div></div><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">¬´ Home</a><a class="docs-footer-nextpage" href="../../APIs/">APIs ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Thursday 13 January 2022 00:17">Thursday 13 January 2022</span>. Using Julia version 1.7.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
